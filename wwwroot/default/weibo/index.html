<!doctype html><html lang="zh"><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>JsAspBBS å¾®åšæ¨¡å¼</title>
<base href="/" />
<style type="text/css">
body{ margin: 0mm; font: 4vw/6vw arial; background-color: #f5f7f8; color: #0b0b37 }
a{ color: unset; text-decoration: none }
img{ max-width: 100%; vertical-align: middle }
.mt{ margin-top: 2vw }
.bg{ background-color: #fff }
.xs{ font-size: 3.5vw }
.xxs{ font-size: 3vw }
.flex{ display: flex }
.flex .auto{ flex: 1 }
.fl{ float: left }
.tr{ text-align: right }
.tc{ text-align: center }
.hide{ display: none }
.gray{ color: #8590a6 }
input{ font: 4vw/6vw arial}
.header{ background: #2469f6; color: #fff; text-align: center; padding: 8vw 0mm }
.header h1{ font: italic 7vw/10vw arial; margin: 0mm; padding: 3vw 0mm }
.header .flex div{ flex: 1 }
.header span{ color: #a7c3fb }
.header b{ font-weight: normal }
.tab{ display: flex; overflow: auto; font: 3.5vw/12vw arial }
.tab p{ margin: 0mm 4vw; white-space: nowrap }
.tab .act{ font-weight: bold; color: #2469f6; border-bottom: 0.5vw solid #2469f6 }
.ding{ line-height: 10vw; padding: 0mm 2vw }
.ding .flex span{ color: #8590a6; padding: 0mm 4vw 0mm 2vw }
.ding .flex a{ text-overflow: ellipsis; overflow: hidden; white-space: nowrap }
.weibo{ padding: 4vw 4vw 0mm; max-height: 999vh; word-wrap: break-word }
.weibo .user{ line-height: 5vw }
.weibo .user .icon{ width: 10vw; height: 10vw; border-radius: 50%; background-color: #8590a6; color: #fff; margin-right: 2vw; line-height: 10vw; text-align: center }
.weibo .user div{ color: #8590a6 }
.weibo .reply{ margin-bottom: 2vw }
.weibo .message a{ color: #2469f6 }
.weibo .message .attach{ font-weight: bold; text-decoration: underline }
.weibo .flex{ border-top: 0.3vw solid #eee; text-align: center }
.weibo .flex div{ padding: 3vw; color: #8590a6 }
.weibo .fixed .message{ max-height: 25vh; overflow: hidden; margin-bottom: -25vw }
.weibo .fixed .show{ position: relative }
.weibo .fixed .show:before{ content: ""; background-image: linear-gradient(rgba(255, 255, 255, 0), #fff); display: block; height: 16vw }
.weibo .fixed .show:after{ content: "æŸ¥çœ‹æ›´å¤š"; display: block; text-align: center; padding: 2vw; background-color: #fff; color: #2469f6 }
.weibo .expand .show:after{ content: "æŠ˜å "; display: block; text-align: center; padding: 2vw; background-color: #fff; color: #2469f6 }
.replies .say input{ border: 0.3vw solid #2469f6; height: 6vw; padding: 1vw 2vw; outline: none; border-radius: 1vw 0mm 0mm 1vw }
.replies .say span{ border: 0.3vw solid #2469f6; background-color: #2469f6; color: #fff; padding: 1vw 3vw; border-radius: 0mm 1vw 1vw 0mm }
.replies .ul{ max-height: 40vh; overflow: auto }
.replies .ul .replytime{ color: #8590a6; font-size: 3vw }
.replies .list .row{ border-top: 0.3vw solid #eee; padding: 3vw 1vw; max-height: 999vh }
.replies .message{ background-color: #f5f7f8; border-radius: 2vw; padding: 1vw 2vw }
.replies .more{ padding-bottom: 2vw; color: #2469f6 }
.login.flex{ position: fixed; background-color:rgba(0, 0, 0, 0.5); bottom: 0mm; left: 0mm; top: 0mm; right: 0mm; flex-direction: column }
.login .win{ width: 80vw; margin: 0mm auto; background-color: #f5f7f8; border-radius: 3vw }
.login .win .cap{ padding: 2vw }
.login .win .info{ background-color: #fff; padding: 2vw 4vw }
.login .win .info .flex{ padding: 2vw }
.login .win .info .flex span{ padding: 1vw }
.login .win .info .flex input{ border: 0.3vw solid #ccc; width: 100%; padding: 1vw 2vw; outline: none; border-radius: 1vw }
.login .win .btn div{ padding: 2vw }
.code textarea{ width: 99%; height: 30vw; font: 4vw/6vw arial }
.wait{ text-align: center; color: #8590a6; font: 3.5vw/20vh arial }
</style></head><body>
<div class="header">
	<h1>-</h1>
	<div class="flex">
		<div><span>æˆå‘˜ï¼š</span><b>-</b></div>
		<div><span>å†…å®¹ï¼š</span><b>-</b></div>
		<div><span>ğŸ’</span><a href="."><b>è®ºå›</b></a></div>
	</div>
</div>
<!-- Tab åˆ†é¡µ -->
<div class="tab bg">
	<p class="act" data-id="0">å…¨éƒ¨</p>
</div>
<!-- ç½®é¡¶åˆ—è¡¨ -->
<div class="mt bg ding xs">
	<div class="flex">
		<span>ç½®é¡¶</span>
		<a class="tt title auto">å®é™…çš„å¸–å­æ ‡é¢˜éœ€é€šè¿‡ fetch åŠ è½½</a>
	</div>
</div>
<!-- å¾®åšåˆ—è¡¨ -->
<div>
	<div class="wait">åŠ è½½ä¸­â€¦</div>
	<div class="weibo mt bg">
		<div class="user xs">
			<b class="tt fname icon fl">ç”¨</b>
			<b class="tt nick">ç”¨æˆ·å</b>
			<div class="tt posttime xxs">2022-04-06</div>
		</div>
		<div class="mt"><a target="_blank"><b class="tt title">è¯·é€šè¿‡æµè§ˆå™¨è®¿é—®æŸ¥çœ‹å®é™…æ ‡é¢˜</b></a></div>
		<div>
			<div class="tt message reply">æ‚¨çœ‹åˆ°çš„æ˜¯æ¨¡æ¿é¡µé¢å†…å®¹ï¼ŒçœŸå®æ•°æ®éœ€è¦ä½¿ç”¨æµè§ˆå™¨åŠ è½½æ‰å¯æŸ¥é˜…ã€‚</div>
			<div class="show" onclick="toggleShow(parentNode)"></div>
		</div>
		<div class="flex xs">
			<div>ğŸ”¥ <span class="tt pv">0</span></div>
			<div class="auto btn-pl">ğŸ’¬ <span class="tt replynum"></span></div>
			<div><a class="tt btn1" target="_blank">è¯¦æƒ…</a></div>
		</div>
		<!-- å›å¤å±•ç¤º -->
		<div class="replies">
			<div class="say tc">
				<div class="flex"><input name="message" placeholder="è¯·è¾“å…¥æ‚¨çš„è¯„è®º" class="auto" /><span class="xs">å‘è¡¨</span></div>
			</div>
			<div class="ul mt">
				<div class="list">
					<div class="row">
						<div class="xs"><b class="tt nick">-</b> <span class="tt replytime">2022-04-10 12:34:56</span></div>
						<div class="tt message">æ‚¨çœ‹åˆ°çš„æ˜¯æ¨¡æ¿é¡µé¢å†…å®¹ï¼Œå¹¶éçœŸå®å›å¤ã€‚çœŸå®æ•°æ®éœ€è¦ä½¿ç”¨æµè§ˆå™¨åŠ è½½æ‰å¯æŸ¥é˜…ã€‚</div>
					</div>
				</div>
				<div class="xs tc more hide">åŠ è½½æ›´å¤š</div>
			</div>
		</div>
	</div>
</div>
<!-- ç™»å½•çª—å£ -->
<div class="login hide">
	<div class="auto"></div>
	<div class="win">
		<div class="cap tc">ç”¨æˆ·ç™»å½•</div>
		<div class="info">
			<div class="tr xs gray"><a href="?r=register">æ²¡æœ‰æ³¨å†Œï¼Ÿ</a></div>
			<div class="flex">
				<span>è´¦å·ï¼š</span>
				<input class="auto" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" name="user" />
			</div>
			<div class="flex">
				<span>å¯†ç ï¼š</span>
				<input type="password" class="auto" name="pass" placeholder="è¯·è¾“å…¥å¯†ç " />
			</div>
			<p></p>
		</div>
		<div class="btn flex tc">
			<div class="auto">å–æ¶ˆ</div>
			<div class="auto">ç™»å½•</div>
		</div>
	</div>
	<div class="auto"></div>
</div>
<script type="text/javascript">
// tab åˆ†é¡µæ¨¡æ¿
var tab = new function() {
	this.bind = function(rows) {
		rows.forEach(function(r) {
			var p = document.createElement("p");
			p.innerHTML = r.nick;
			p.setAttribute("data-id", r.forumid);
			menu.appendChild(p);
		});
	};
	var menu = document.querySelector(".tab");
	var item = menu.querySelector("p");
	var actItem = item;
	menu.addEventListener("click", function(e) {
		if (e.target.nodeName != "P") return;
		if(e.target == actItem) return;
		actItem.className = "";
		actItem = e.target;
		actItem.className = "act";
		weibos.forumid = ~~actItem.dataset.id;
		weibos.lastid = 0;
		weibos.showwait();
		weibos.loadmore();
	});
};

// å¾®åšåˆ—è¡¨æ¨¡æ¿
var weibos = new function() {
	this.bind = function(rows) {
		rows.forEach(function(x) {
			x.fname = x.nick.substr(0, 1);
			x.date = x.posttime.substr(0, 10);
			x.btn1 = "è¯¦æƒ…";
			tt.forEach(function(y) {
				var col = y.classList[1];
				y.innerHTML = fmtMsg(x[col]);
				var href = "?r=topic/" + x.topicid;
				if(col == "replynum" || col == "title") y.parentNode.href = href;
				if(col == "btn1") y.href = href;
			});
			var row = list.appendChild(temp.cloneNode(true));
			var reply = row.querySelector(".reply").parentNode;
			var img = row.querySelectorAll("img");
			var clipd = setClip(reply);
			img.forEach(function(x) {
				x.onload = x.onerror = function() {
					if(clipd) return;
					clipd = setClip(reply);
				};
			});
			tempPL.init(row, x);
		});
	};
	this.loadmore = function() {
		var form = new Object;
		if(this.lastid) form.lastid = this.lastid;
		if(this.forumid) form.forumid = this.forumid;
		post("weibo/topicList", form, function(res) {
			weibos.loading = false;
			if(res.err) return alert(res.err);
			if(!weibos.lastid) {
				list.innerHTML = "";
				dings.bind(res.dings);
			}
			weibos.lastid = res.topics.length > 10 ? res.topics.pop().topicid : 0;
			weibos.bind(res.topics);
		});
		this.loading = true;
	};
	this.clear = function() { list.innerHTML = ""; };
	this.showwait = function() { list.innerHTML = "<div class='wait'>åŠ è½½ä¸­...</div>"; };
	function setClip(reply) {
		// åˆ¤æ–­ reply çš„é«˜åº¦ï¼Œå¦‚æœè¶…è¿‡å±å¹•é«˜åº¦ï¼Œåˆ™è£å‰ª
		if(reply.offsetHeight > window.innerHeight / 4) {
			reply.className = "fixed"; return true;
		}
		return false;
	}
	var temp = document.querySelector(".weibo");
	var tempPL = new TempPL(temp.querySelector(".replies .list .row"));
	var tt = temp.querySelectorAll(".tt");
	var list = temp.parentNode;
	list.removeChild(temp);
};

// è¯„è®ºåˆ—è¡¨æ¨¡æ¿
function TempPL(temp) {
	var me = this;
	this.init = function(topic, data) {
		// é—­åŒ…ä½œç”¨åŸŸèŒƒå›´ï¼šå•ä¸ªä¸»é¢˜
		var btnPL = topic.querySelector(".flex .btn-pl");	// æ˜¾ç¤ºè¯„è®ºåˆ—è¡¨æŒ‰é’®
		var layPL = topic.querySelector(".replies");
		data.tagSay = layPL.querySelector(".say");
		data.tagIpt = data.tagSay.querySelector(".flex");
		data.tagNum = topic.querySelector(".replynum");
		data.tagSay.innerHTML = "";
		
		layPL.className = "hide";
		// æ˜¾ç¤º/éšè—è¯„è®ºåˆ—è¡¨
		btnPL.addEventListener("click", function() {
			if(login.hasLogin) data.showSay();
			layPL.className = layPL.className == "replies" ? "hide" : "replies";
			if(data.more) return;	// å¦‚éœ€åˆ·æ–°ï¼Œdelete data.more
			data.ul = layPL.querySelector(".ul .list");
			// é‡æ–°åˆå§‹åŒ–å‚æ•°
			data.ul.innerHTML = ""; data.lastid = 0;
			// åŠ è½½æ›´å¤š
			data.more = layPL.querySelector(".more");
			data.more.onclick = function() {
				if( data.lastid > 0) loadReplies(data);
			};
			loadReplies(data);
		});
		// å·²ç™»å½•æ˜¾ç¤ºè¯„è®ºæ¡†
		data.showSay = function() {
			this.tagSay.innerHTML = "";
			this.tagSay.appendChild(this.tagIpt);
		};
		// æœªç™»å½•æ˜¾ç¤ºç™»å½•æŒ‰é’®
		data.showLogin = function() {
			this.tagSay.innerHTML = "<u>ç™»å½•åå¯å‘è¡¨è¯„è®º</u>";
			this.tagSay.lastChild.onclick = function() { login.show(data); };
		};
		// ç‚¹å‡»å‘è¡¨è¯„è®º
		data.tagIpt.querySelector("span").onclick = function() {
			if(data.replying) return;
			data.replying = true;
			var ipt = data.tagIpt.querySelector("input");
			var txt = ipt.value;
			if(!txt) return alert("è¯·è¾“å…¥è¯„è®ºå†…å®¹");
			post("api/replyAdd", { topicid: data.topicid, message: txt }, function(res) {
				data.replying = false;
				if(res.err) return alert(res.err);
				data.tagNum.innerHTML -= -1;
				data.lastid = 0; ipt.value = data.ul.innerHTML = "";
				alert(res.msg); loadReplies(data);
			});
		};
	};
	// ç»‘å®šåˆ—è¡¨
	this.bind = function(ul, rows) {
		rows.forEach(function(r) {
			r.message = fmtMsg(r.message);
			tt.forEach(function(y) {
				var col = y.classList[1];
				y.innerHTML = r[col];
			});
			ul.appendChild(temp.cloneNode(true));
		});
	};
	// é—­åŒ…ä½œç”¨åŸŸèŒƒå›´ï¼šæ‰€æœ‰ä¸»é¢˜
	function loadReplies(data) {
		if(data.posting) return;
		data.posting = true;
		var form = { topicid: data.topicid, firstid: data.replyid, lastid: ~~data.lastid };
		if(form.lastid < 0) return;
		post("weibo/replies", form, function(res) {
			data.posting = false;
			if(res.err) return alert(res.err);
			data.lastid = res.replies.length > 10 ? res.replies.pop().replyid : -1;
			data.more.className = data.lastid < 0 ? "xs tc more hide" : "xs tc more";
			!res.userid ? data.showLogin() : data.showSay();
			me.bind(data.ul, res.replies);
		});
	}
	var tt = temp.querySelectorAll(".tt");
	temp.parentNode.removeChild(temp);
}

// ç½®é¡¶åˆ—è¡¨æ¨¡æ¿
var dings = new function() {
	this.bind = function(rows) {
		list.innerHTML = "";
		rows.forEach(function(x) {
			tt.forEach(function(y) {
				y.innerHTML = x[y.classList[1]];
			});
			tt[0].href = "?r=topic/" + x.topicid;
			var row = list.appendChild(temp.cloneNode(true));
		});
	};
	var temp = document.querySelector(".ding .flex");
	var tt = temp.querySelectorAll(".tt");
	var list = temp.parentNode;
	list.removeChild(temp);
};

// åŠ è½½é¦–é¡µæ•°æ®
post("weibo/home", "", function(res) {
	if(res.err) return alert(res.err);
	// ç»‘å®šå¤´éƒ¨ä¿¡æ¯
	var header = document.querySelectorAll(".header h1, .header b");
	header[0].textContent = document.title = res.sitename;
	header[1].textContent = res.total.users;
	header[2].textContent = res.total.topics;
	tab.bind(res.forums);
	dings.bind(res.dings);
	weibos.lastid = res.topics.length > 10 ? res.topics.pop().topicid : 0;
	// ç»‘å®šå¾®åšåˆ—è¡¨
	weibos.clear();
	weibos.bind(res.topics);
});

// Post è¯·æ±‚
function post(api, form, func) {
	fetch("/?r=" + api, {
		headers: { "Content-Type": "application/x-www-form-urlencoded" },
		body: parseForm(form), method: "POST"
	}).then(function(response) { return response.json(); }).then(function(json) { func(json); });
}
// è§£æè¡¨å•
function parseForm(form) {
	if(!form) return "";
	if("object" != typeof form) return form;
	var arr = new Array;
	for(var x in form) {
		arr.push(encodeURIComponent(x) + "=" + encodeURIComponent(form[x]));
	}
	return arr.join("&");
}
// è®ºå›å¸–å­æ ¼å¼åŒ–
function fmtMsg(str) {
	var str = (str || "") + "", arrCode = new Array;
	str = str.replace(/\[html\]([\s\S]+?)\[\/html\]/gi, function(txt, code) {
		arrCode.push(code);
		return "[html=\x01]";
	});
	str = str.replace(/\t/g, "    ").replace(/  /g, "&nbsp; ").replace(/\r?\n/g, "<br />\r\n").
		replace(/\[(.+?)\]\((\w+)\:(.+?)\)/g, '<a href="$2:$3" target="_blank">$1</a>').
		replace(/\[(b|i|u)\](.+?)\[\/\1\]/g, "<$1>$2</$1>").
		replace(/\[(b|i|u)\](.+?)\[\/\1\]/g, "<$1>$2</$1>").
		replace(/\[(b|i|u)\](.+?)\[\/\1\]/g, "<$1>$2</$1>").
		replace(/\*\*(.+)\*\*/g, "<b>$1</b>").replace(/\*(.+)\*/g, "<i>$1</i>").
		replace(/\[color=([\#\w]+)\](.+?)\[\/color\]/g, '<font color="$1">$2</font>').
		replace(/\[bgcolor=([\#\w]+)\](.+?)\[\/bgcolor\]/g, '<font style="background-color: $1">$2</font>').
		replace(/\`\`\`([\s\S]+?)\`\`\`/g, "<blockquote>$1</blockquote>").
		replace(/\[(image|upload)=([^\]]+)\]/g, function(src, $1, $2) {
			var file = $2.split("|");
			return $1 == "image" ? '<div><a href="' + file[0] + '" target="_blank"><img src="' + file[0] + '" alt="' + file[1] + '" /></a></div>'
				: ('<a href="' + file[0] + '" class="attach" target="_blank">' + file[1] + '</a>(' + file[2] + ')');
		});
	return str.replace(/\[html=\x01\]/g, function() {
		return '<div class="code"><textarea>' + arrCode.shift() + '</textarea><p class="tr">[æ‚¨å¯ä»¥å…ˆä¿®æ”¹ä»£ç å†è¿è¡Œ] <input type="button" value="æ‰§è¡Œä»£ç " onclick="runcode(parentNode)" /></p></div>';
	});
}
function runcode(tag) {
	var win = open("about:blank", "_blank", "");
	win.document.write(tag.parentNode.firstChild.value);
}

// åˆ‡æ¢æ˜¾ç¤ºæ”¶ç¼©
function toggleShow(tag) { tag.className = tag.className == "fixed" ? "expand" : "fixed"; }

var login = new function() {
	this.show = function(data) { tag.className = "login flex"; this.topic = data; };
	this.hide = function() { tag.className = "login hide"; };
	var tag = document.querySelector(".login");
	var ipt = tag.querySelectorAll(".win .info input");
	var btn = tag.querySelectorAll(".win .btn div");
	btn[0].onclick = function() { me.hide(); };
	btn[1].onclick = function() {
		// ç”¨æˆ·ç™»å½•
		if(!ipt[0].value || !ipt[1].value) return alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ");
		post("api/login", { user: ipt[0].value, pass: ipt[1].value }, function(res) {
			if(res.err) return alert(res.err);
			me.topic?.showSay();	// ç™»å½•æˆåŠŸåç«‹å³æ˜¾ç¤ºå‘å¸ƒæ¡†
			me.hide(); me.hasLogin = true;
		});
	};
	var me = this;
};

// è§¦åº•äº‹ä»¶
window.onscroll = function() {
	var root = document.documentElement;
	// è®¾ç½®è§¦åº•è·ç¦»
	var reach = root.clientHeight / 20, stop = root.scrollTop || document.body.scrollTop;
	if(root.scrollHeight - stop - root.clientHeight > reach) return;
	if(weibos.loading || !weibos.lastid) return;
	weibos.loadmore();
};
</script>
</body></html>